<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√¥ Ph·ªèng Giao Thoa S√≥ng C∆°</title> <!-- ƒê√£ s·ª≠a ti√™u ƒë·ªÅ HTML -->
    <!-- T·∫£i Tailwind CSS ƒë·ªÉ t·∫°o giao di·ªán ƒë·∫πp v√† responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/tailwind-config.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="css/global.css">
    <style>
        /* Thi·∫øt l·∫≠p font Inter. Background color is now handled by Tailwind classes */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Thi·∫øt l·∫≠p Canvas cho m√¥ ph·ªèng */
        #waveCanvas {
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            /* background-color handled by JS for consistency with drawing loop */
            touch-action: none;
            display: block;
        }

        /* Custom styles cho c√°c thanh range slider */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #cbd5e1;
            /* slate-300 for light mode default */
            border-radius: 4px;
            outline: none;
            transition: opacity .2s;
        }

        .dark input[type="range"] {
            background: #334155;
            /* slate-700 for dark mode */
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #3b82f6;
            /* blue-500 */
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.2);
        }

        .dark input[type="range"]::-webkit-slider-thumb {
            background: #60a5fa;
            /* blue-400 */
            border-color: #0f172a;
        }

        /* Style cho c√°c h·ªôp Stats/Legend tr√™n Canvas */
        .info-box {
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #e2e8f0;
            color: #1e293b;
            font-family: monospace;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .dark .info-box {
            background-color: rgba(15, 23, 42, 0.85);
            border: 1px solid #334155;
            color: #f1f5f9;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        /* Style cho n√∫t T·∫°m D·ª´ng */
        #togglePause {
            transition: background-color 0.2s, transform 0.1s;
        }

        #togglePause:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
    </style>
</head>

<body
    class="p-4 md:p-8 min-h-screen flex items-center justify-center bg-gray-50 dark:bg-[#0d1117] text-gray-900 dark:text-[#c9d1d9] transition-colors duration-300">

    <a href="index.html"
        class="fixed top-4 left-4 z-50 p-3 bg-blue-600 text-white rounded-lg shadow-xl hover:bg-blue-700 transition duration-300 flex items-center space-x-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path
                d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
        </svg>
        <span class="font-semibold hidden sm:inline">Quay v·ªÅ Trang Ch·ªß</span>
    </a>



    <div class="w-full max-w-7xl">
        <h1 class="text-3xl font-bold mb-6 text-center text-blue-600 dark:text-blue-400">üåä M√¥ Ph·ªèng Giao Thoa S√≥ng C∆°
        </h1> <!-- ƒê√£ s·ª≠a ti√™u ƒë·ªÅ hi·ªÉn th·ªã -->

        <div class="flex flex-col lg:flex-row gap-6">

            <!-- CONTROL PANEL -->
            <div
                class="lg:w-1/3 bg-white dark:bg-[#161b22] p-6 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 h-fit">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800 dark:text-white">ƒêi·ªÅu Khi·ªÉn</h2>
                    <button onclick="toggleDarkMode()"
                        class="p-2 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
                        title="Ch·∫ø ƒë·ªô T·ªëi/S√°ng">
                        <i id="theme-icon" data-lucide="moon" class="w-5 h-5"></i>
                    </button>
                </div>

                <!-- N√∫t T·∫°m D·ª´ng / Ti·∫øp T·ª•c -->
                <button id="togglePause"
                    class="w-full py-2 px-4 rounded-lg font-bold text-lg mb-6 text-white bg-red-600 hover:bg-red-700 shadow-xl">
                    ‚è∏Ô∏è T·∫°m D·ª´ng
                </button>

                <!-- Kho·∫£ng c√°ch gi·ªØa hai ngu·ªìn -->
                <div class="mb-4">
                    <label for="sourceDistance" class="block text-sm font-medium mb-1">Kho·∫£ng c√°ch gi·ªØa hai ngu·ªìn (d):
                        <span id="distValue" class="font-mono text-green-600 dark:text-green-400">200.0</span>
                        px</label>
                    <input type="range" id="sourceDistance" min="50" max="400" step="10" value="200" class="w-full">
                </div>

                <!-- T·∫ßn s·ªë -->
                <div class="mb-4">
                    <label for="frequency" class="block text-sm font-medium mb-1">T·∫ßn s·ªë (f): <span id="freqValue"
                            class="font-mono text-green-600 dark:text-green-400">1.0</span> Hz</label>
                    <input type="range" id="frequency" min="0.5" max="5.0" step="0.1" value="1.0" class="w-full">
                </div>

                <!-- Pha ban ƒë·∫ßu -->
                <div class="mb-4">
                    <label for="phaseDiff" class="block text-sm font-medium mb-1">ƒê·ªô l·ªách pha ban ƒë·∫ßu (&Delta;&phi;):
                        <span id="phaseValue" class="font-mono text-green-600 dark:text-green-400">0</span> &pi;
                        rad</label>
                    <input type="range" id="phaseDiff" min="0" max="2" step="0.1" value="0" class="w-full">
                </div>

                <!-- Bi√™n ƒë·ªô S√≥ng 1 -->
                <div class="mb-4">
                    <label for="amp1" class="block text-sm font-medium mb-1">Bi√™n ƒë·ªô S√≥ng 1 (A‚ÇÅ): <span id="amp1Value"
                            class="font-mono text-green-600 dark:text-green-400">1.0</span></label>
                    <input type="range" id="amp1" min="0.1" max="2.0" step="0.1" value="1.0" class="w-full">
                </div>

                <!-- Bi√™n ƒë·ªô S√≥ng 2 -->
                <div class="mb-6">
                    <label for="amp2" class="block text-sm font-medium mb-1">Bi√™n ƒë·ªô S√≥ng 2 (A‚ÇÇ): <span id="amp2Value"
                            class="font-mono text-green-600 dark:text-green-400">1.0</span></label>
                    <input type="range" id="amp2" min="0.1" max="2.0" step="0.1" value="1.0" class="w-full">
                </div>

                <div class="mb-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold mb-2 text-gray-800 dark:text-white">Hi·ªÉn Th·ªã V√¢n Giao Thoa Tƒ©nh
                    </h3>

                    <div class="flex items-center space-x-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="toggleMaxima" class="form-checkbox text-blue-500 h-4 w-4 rounded"
                                checked>
                            <!-- C·∫≠p nh·∫≠t m√†u s·∫Øc cho checkbox -->
                            <span class="ml-2 text-sm text-gray-800 dark:text-white">V√¢n C·ª±c ƒê·∫°i</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="toggleMinima" class="form-checkbox text-blue-500 h-4 w-4 rounded"
                                checked>
                            <!-- C·∫≠p nh·∫≠t m√†u s·∫Øc cho checkbox -->
                            <span class="ml-2 text-sm text-[#FF00FF]">V√¢n C·ª±c Ti·ªÉu</span>
                        </label>
                    </div>
                </div>

                <p class="text-xs text-gray-500 mt-4 italic">
                    L∆∞u √Ω: T·ªëc ƒë·ªô s√≥ng (v) ƒë∆∞·ª£c c·ªë ƒë·ªãnh l√† 50 pixels/s. B∆∞·ªõc s√≥ng &lambda; = v/f.
                </p>
            </div>

            <!-- CANVAS SIMULATION CONTAINER (Relative position to hold absolute info boxes) -->
            <div class="lg:w-2/3 flex justify-center items-center relative">
                <canvas id="waveCanvas" class="w-full aspect-square max-w-full"></canvas>

                <!-- Stats Box (Top Left, Absolute Position) -->
                <div id="statsBox" class="info-box absolute top-4 left-4 p-3 rounded-md text-xs sm:text-sm shadow-xl">
                    <p>t = <span id="statTime">0.00</span> s</p>
                    <p>f = <span id="statFreq">1.0</span> Hz</p>
                    <p>&lambda; = <span id="statLambda">50.0</span> px</p>
                    <p>d = <span id="statDist">200.0</span> px</p>
                </div>

                <!-- Legend Box (Top Right, Absolute Position) -->
                <div class="info-box absolute top-4 right-4 p-3 rounded-md text-xs sm:text-sm shadow-xl">
                    <div class="flex items-center mb-1">
                        <!-- C·∫≠p nh·∫≠t m√†u s·∫Øc cho Legend: Tr·∫Øng -->
                        <div class="w-4 h-4 rounded-sm" style="background-color: #FFFFFF;"></div>
                        <span class="ml-2">C·ª±c ƒë·∫°i giao thoa v·ªõi bi√™n ƒë·ªô c·ª±c ti·ªÉu</span>
                    </div>
                    <div class="flex items-center">
                        <!-- C·∫≠p nh·∫≠t m√†u s·∫Øc cho Legend: H·ªìng C√°nh Sen -->
                        <div class="w-4 h-4 rounded-sm" style="background-color: #FF00FF;"></div>
                        <span class="ml-2">C·ª±c ƒë·∫°i giao thoa v·ªõi bi√™n ƒë·ªô c·ª±c ƒë·∫°i</span>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script type="module">
        const canvas = document.getElementById('waveCanvas');
        const ctx = canvas.getContext('2d');
        const controls = {
            togglePause: document.getElementById('togglePause'), // N√∫t m·ªõi
            sourceDistance: document.getElementById('sourceDistance'),
            frequency: document.getElementById('frequency'),
            phaseDiff: document.getElementById('phaseDiff'),
            amp1: document.getElementById('amp1'),
            amp2: document.getElementById('amp2'),
            toggleMaxima: document.getElementById('toggleMaxima'),
            toggleMinima: document.getElementById('toggleMinima'),
            // Value displays
            distValue: document.getElementById('distValue'),
            freqValue: document.getElementById('freqValue'),
            phaseValue: document.getElementById('phaseValue'),
            amp1Value: document.getElementById('amp1Value'),
            amp2Value: document.getElementById('amp2Value'),
            // Stat elements
            statTime: document.getElementById('statTime'),
            statFreq: document.getElementById('statFreq'),
            statLambda: document.getElementById('statLambda'),
            statDist: document.getElementById('statDist'),
        };

        // --- H·∫∞NG S·ªê V·∫¨T L√ù V√Ä THI·∫æT L·∫¨P BAN ƒê·∫¶U ---
        const V_WAVE = 50; // T·ªëc ƒë·ªô s√≥ng (pixels/s)
        const PI2 = 2 * Math.PI;
        let animationFrameId = null; // ID c·ªßa requestAnimationFrame
        let isPaused = false; // Tr·∫°ng th√°i t·∫°m d·ª´ng
        let lastTime = 0;
        let elapsedTime = 0; // Th·ªùi gian tr√¥i qua ƒë·ªÉ t·∫°o hi·ªáu ·ª©ng s√≥ng ƒë·ªông

        // V·ªã tr√≠ c√°c ngu·ªìn s√≥ng (S1 v√† S2)
        let S1 = { x: 0, y: 0 };
        let S2 = { x: 0, y: 0 };
        let SOURCE_DISTANCE = parseFloat(controls.sourceDistance.value);

        // --- THAM S·ªê NG∆Ø·ªúI D√ôNG ƒêI·ªÄU KHI·ªÇN ---
        let f = parseFloat(controls.frequency.value);
        let deltaPhi_pi = parseFloat(controls.phaseDiff.value);
        let A1 = parseFloat(controls.amp1.value);
        let A2 = parseFloat(controls.amp2.value);
        let showMaxima = controls.toggleMaxima.checked;
        let showMinima = controls.toggleMinima.checked;

        // M√†u s·∫Øc cho s√≥ng (s·∫Ω ƒë∆∞·ª£c thay ƒë·ªïi ƒë·ªông theo theme)
        let BG_R, BG_G, BG_B;
        let MAXIMA_COLOR, MINIMA_COLOR;

        function updateColorConstants() {
            const isDark = document.documentElement.classList.contains('dark');
            if (isDark) {
                BG_R = 14; BG_G = 21; BG_B = 38; // Deep Navy (#0e1526)
                MAXIMA_COLOR = [170, 255, 0];    // Yellow-Green
                MINIMA_COLOR = [0, 170, 255];    // Blue-Cyan
            } else {
                BG_R = 255; BG_G = 255; BG_B = 255; // White
                MAXIMA_COLOR = [59, 130, 246];   // Blue-500 for Postive Maxima
                MINIMA_COLOR = [239, 68, 68];    // Red-500 for Negative Maxima
            }
        }
        updateColorConstants(); // Init colors

        // M√†u s·∫Øc m·ªõi cho c√°c ƒë∆∞·ªùng tƒ©nh (ƒë√£ thay ƒë·ªïi)
        let STATIC_MAXIMA_COLOR;
        let STATIC_MINIMA_COLOR;

        function updateStaticColorConstants() {
            const isDark = document.documentElement.classList.contains('dark');
            STATIC_MAXIMA_COLOR = isDark ? '#FFFFFF' : '#1e293b'; // White or Slate-800
            STATIC_MINIMA_COLOR = '#FF00FF'; // Magenta constantly
        }
        updateStaticColorConstants();

        // --- C√ÅC H√ÄM T√çNH TO√ÅN V·∫¨T L√ù ---

        function calculateWaveParameters() {
            const omega = PI2 * f;
            const lambda = V_WAVE / f;
            const k = PI2 / lambda;
            return { omega, lambda, k };
        }

        /**
         * T√≠nh ƒë·ªô d·ªãch chuy·ªÉn t·ªïng h·ª£p t·∫°i ƒëi·ªÉm (x, y) v√† th·ªùi ƒëi·ªÉm t.
         */
        function calculateDisplacement(x, y, t) {
            const { omega, k } = calculateWaveParameters();
            const deltaPhi_0 = deltaPhi_pi * Math.PI;

            const d1 = Math.sqrt((x - S1.x) ** 2 + (y - S1.y) ** 2);
            const d2 = Math.sqrt((x - S2.x) ** 2 + (y - S2.y) ** 2);

            const u1 = A1 * Math.cos(omega * t - k * d1);
            const u2 = A2 * Math.cos(omega * t - k * d2 + deltaPhi_0);

            return u1 + u2;
        }

        // --- H√ÄM V·∫º V√Ä RENDER ---

        /**
         * H√†m v·∫Ω m√¥ ph·ªèng ƒë·ªông
         */
        function drawSimulation() {
            if (canvas.width <= 0 || canvas.height <= 0) return;

            const maxDisplacement = A1 + A2;
            const imageData = ctx.createImageData(canvas.width, canvas.height);
            const data = imageData.data;

            for (let y = 0; y < canvas.height; y++) {
                for (let x = 0; x < canvas.width; x++) {
                    const index = (y * canvas.width + x) * 4;

                    // T√≠nh to√°n ƒë·ªô d·ªãch chuy·ªÉn t·∫°i th·ªùi ƒëi·ªÉm hi·ªán t·∫°i
                    const u = calculateDisplacement(x, y, elapsedTime);
                    const normalizedU = u / maxDisplacement;
                    let intensity = Math.abs(normalizedU);

                    // Ch·ªçn m√†u s√≥ng d·ª±a tr√™n chi·ªÅu d·ªãch chuy·ªÉn (c·ª±c ƒë·∫°i d∆∞∆°ng, c·ª±c ti·ªÉu √¢m)
                    let waveR = normalizedU > 0 ? MAXIMA_COLOR[0] : MINIMA_COLOR[0];
                    let waveG = normalizedU > 0 ? MAXIMA_COLOR[1] : MINIMA_COLOR[1];
                    let waveB = normalizedU > 0 ? MAXIMA_COLOR[2] : MINIMA_COLOR[2];

                    // S·ª≠ d·ª•ng h√†m m≈© ƒë·ªÉ l√†m s·∫Øc n√©t c√°c ƒë∆∞·ªùng s√≥ng (hi·ªáu ·ª©ng glow)
                    const waveFactor = Math.pow(intensity, 1.5);

                    // Pha tr·ªôn m√†u s√≥ng v·ªõi m√†u n·ªÅn s√¢u
                    data[index] = Math.floor(BG_R * (1 - waveFactor) + waveR * waveFactor);
                    data[index + 1] = Math.floor(BG_G * (1 - waveFactor) + waveG * waveFactor);
                    data[index + 2] = Math.floor(BG_B * (1 - waveFactor) + waveB * waveFactor);
                    data[index + 3] = 255;
                }
            }
            ctx.putImageData(imageData, 0, 0);
        }

        /**
         * H√†m v·∫Ω c√°c ƒë∆∞·ªùng c·ª±c ƒë·∫°i v√† c·ª±c ti·ªÉu tƒ©nh
         */
        function drawStaticLines() {
            const { lambda } = calculateWaveParameters();
            const deltaPhi_0 = deltaPhi_pi * Math.PI;

            const phaseShiftDistance = (lambda * deltaPhi_0) / PI2;
            const maxK = Math.ceil(SOURCE_DISTANCE / lambda) + 2;

            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 1;

            for (let y = 0; y < canvas.height; y++) {
                for (let x = 0; x < canvas.width; x++) {
                    const d1 = Math.sqrt((x - S1.x) ** 2 + (y - S1.y) ** 2);
                    const d2 = Math.sqrt((x - S2.x) ** 2 + (y - S2.y) ** 2);
                    const deltaD = d1 - d2;

                    for (let k = -maxK; k <= maxK; k++) {

                        const maximaCondition = k * lambda - phaseShiftDistance;
                        const minimaCondition = (k + 0.5) * lambda - phaseShiftDistance;

                        const tolerance = 0.5; // Dung sai ƒë·ªÉ v·∫Ω ƒë∆∞·ªùng (pixels)

                        if (showMaxima && Math.abs(deltaD - maximaCondition) < tolerance) {
                            // S·ª¨ D·ª§NG M√ÄU TR·∫ÆNG CHO C·ª∞C ƒê·∫†I Tƒ®NH
                            ctx.fillStyle = STATIC_MAXIMA_COLOR;
                            ctx.fillRect(x, y, 1, 1);
                        } else if (showMinima && Math.abs(deltaD - minimaCondition) < tolerance) {
                            // S·ª¨ D·ª§NG M√ÄU H·ªíNG C√ÅNH SEN CHO C·ª∞C TI·ªÇU Tƒ®NH
                            ctx.fillStyle = STATIC_MINIMA_COLOR;
                            ctx.fillRect(x, y, 1, 1);
                        }
                    }
                }
            }
        }

        /**
         * H√†m v·∫Ω c√°c ngu·ªìn s√≥ng S1 v√† S2
         */
        function drawSources() {
            ctx.fillStyle = '#ff0000'; // M√†u ƒë·ªè t∆∞∆°i cho ngu·ªìn s√≥ng

            // S1
            ctx.beginPath();
            ctx.arc(S1.x, S1.y, 8, 0, PI2);
            ctx.fill();
            ctx.fillStyle = document.documentElement.classList.contains('dark') ? '#ffffff' : '#1f2937'; // M√†u ch·ªØ
            ctx.font = '16px Inter';
            ctx.fillText('S‚ÇÅ', S1.x - 5, S1.y - 18);

            // S2
            ctx.beginPath();
            ctx.arc(S2.x, S2.y, 8, 0, PI2);
            ctx.fill();
            ctx.fillStyle = document.documentElement.classList.contains('dark') ? '#ffffff' : '#1f2937';
            ctx.fillText('S‚ÇÇ', S2.x - 5, S2.y + 25);
        }

        /**
         * C·∫≠p nh·∫≠t s·ªë li·ªáu th·ªëng k√™ (Stats) tr√™n giao di·ªán HTML
         */
        function updateStats() {
            const { lambda } = calculateWaveParameters();
            controls.statTime.textContent = elapsedTime.toFixed(2);
            controls.statFreq.textContent = f.toFixed(1);
            controls.statLambda.textContent = lambda.toFixed(1);
            controls.statDist.textContent = SOURCE_DISTANCE.toFixed(1);
        }

        // --- CHU TR√åNH ANIMATION (V√≤ng l·∫∑p ch√≠nh) ---

        function animate(timestamp) {
            if (isPaused) {
                lastTime = 0; // ƒê·∫∑t l·∫°i lastTime ƒë·ªÉ khi ti·∫øp t·ª•c, deltaTime kh√¥ng qu√° l·ªõn
                // Kh√¥ng return ƒë·ªÉ ti·∫øp t·ª•c v·∫Ω l·∫°i canvas khi resize theme, nh∆∞ng kh√¥ng update elapsedTime
                // Tuy nhi√™n animationFrameId s·∫Ω null n·∫øu paused, n√™n ta c·∫ßn g·ªçi drawSimulation m·ªôt l·∫ßn n·∫øu c·∫ßn
            } else {
                if (!lastTime) lastTime = timestamp;
                const deltaTime = (timestamp - lastTime) / 1000;
                lastTime = timestamp;
                elapsedTime += deltaTime;
            }

            if (canvas.width <= 0 || canvas.height <= 0) {
                animationFrameId = requestAnimationFrame(animate);
                return;
            }

            if (!lastTime) lastTime = timestamp;
            const deltaTime = (timestamp - lastTime) / 1000;
            lastTime = timestamp;
            elapsedTime += deltaTime;

            // 1. V·∫Ω m√¥ ph·ªèng ƒë·ªông
            drawSimulation();

            // 2. V·∫Ω c√°c ƒë∆∞·ªùng tƒ©nh (Max/Min)
            if (showMaxima || showMinima) {
                drawStaticLines();
            }

            // 3. V·∫Ω ngu·ªìn s√≥ng
            drawSources();

            // 4. C·∫≠p nh·∫≠t s·ªë li·ªáu th·ªëng k√™
            updateStats();

            animationFrameId = requestAnimationFrame(animate);
        }

        // --- H√ÄM T·∫†M D·ª™NG/TI·∫æP T·ª§C ---
        function togglePause() {
            isPaused = !isPaused;
            const button = controls.togglePause;

            if (isPaused) {
                // T·∫°m d·ª´ng
                button.textContent = "‚ñ∂Ô∏è Ti·∫øp T·ª•c";
                button.classList.remove('bg-red-600', 'hover:bg-red-700');
                button.classList.add('bg-green-600', 'hover:bg-green-700');
                // Ch·ª©c nƒÉng t·∫°m d·ª´ng ƒë∆∞·ª£c th·ª±c hi·ªán trong h√†m animate
            } else {
                // Ti·∫øp t·ª•c
                button.textContent = "‚è∏Ô∏è T·∫°m D·ª´ng";
                button.classList.remove('bg-green-600', 'hover:bg-green-700');
                button.classList.add('bg-red-600', 'hover:bg-red-700');
                if (!animationFrameId) {
                    lastTime = 0; // Reset lastTime ƒë·ªÉ tr√°nh nh·∫£y th·ªùi gian
                    animationFrameId = requestAnimationFrame(animate);
                }
            }
        }

        // --- X·ª¨ L√ù S·ª∞ KI·ªÜN V√Ä RESIZE ---

        /**
         * Thi·∫øt l·∫≠p v·ªã tr√≠ ngu·ªìn s√≥ng (ƒë·∫∑t ch√∫ng tr√™n c√πng m·ªôt tr·ª•c X, c√°ch ƒë·ªÅu t√¢m Y)
         */
        function setupSources(canvasWidth, canvasHeight) {
            const centerY = canvasHeight / 2;

            // SOURCE_DISTANCE (d) ƒë∆∞·ª£c l·∫•y t·ª´ gi√° tr·ªã ƒëi·ªÅu khi·ªÉn.

            // ƒê∆ØA NGU·ªíN S√ìNG V·ªÄ G·∫¶N S√ÅT B√äN TR√ÅI (10% chi·ªÅu r·ªông)
            const sourceX = canvasWidth * 0.1;

            // ƒê·∫∑t S1 v√† S2 th·∫≥ng h√†ng d·ªçc, c√°ch ƒë·ªÅu t√¢m Y, v·ªõi kho·∫£ng c√°ch l√† SOURCE_DISTANCE
            S1.x = sourceX;
            S1.y = centerY - SOURCE_DISTANCE / 2;
            S2.x = sourceX;
            S2.y = centerY + SOURCE_DISTANCE / 2;

            // C·∫≠p nh·∫≠t kho·∫£ng c√°ch ngu·ªìn trong Stats Box
            controls.statDist.textContent = SOURCE_DISTANCE.toFixed(1);
        }

        /**
         * X·ª≠ l√Ω resize: c·∫≠p nh·∫≠t k√≠ch th∆∞·ªõc canvas v√† v·ªã tr√≠ ngu·ªìn
         */
        function handleResize() {
            const container = canvas.parentElement;
            // ƒê·∫£m b·∫£o canvas l√† h√¨nh vu√¥ng v√† chi·∫øm ƒë·ªß chi·ªÅu r·ªông
            const size = Math.min(container.clientWidth, window.innerHeight * 0.7);
            canvas.width = size;
            canvas.height = size;
            // G·ªçi setupSources ƒë·ªÉ ƒë·ªãnh v·ªã l·∫°i S1, S2 d·ª±a tr√™n SOURCE_DISTANCE hi·ªán t·∫°i v√† k√≠ch th∆∞·ªõc canvas m·ªõi
            setupSources(canvas.width, canvas.height);

            if (!isPaused && !animationFrameId) {
                lastTime = 0;
                animationFrameId = requestAnimationFrame(animate);
            }

            // N·∫øu t·∫°m d·ª´ng, v·∫´n c·∫ßn v·∫Ω l·∫°i m·ªôt l·∫ßn sau khi resize ƒë·ªÉ c√°c ƒë∆∞·ªùng tƒ©nh v√† ngu·ªìn ƒë∆∞·ª£c cƒÉn ch·ªânh l·∫°i
            if (isPaused) {
                drawSimulation();
                if (showMaxima || showMinima) {
                    drawStaticLines();
                }
                drawSources();
            }
        }

        /**
         * C·∫≠p nh·∫≠t c√°c bi·∫øn khi ng∆∞·ªùi d√πng thay ƒë·ªïi controls
         */
        function updateParameters() {
            // C·∫≠p nh·∫≠t kho·∫£ng c√°ch ngu·ªìn (SOURCE_DISTANCE) t·ª´ thanh tr∆∞·ª£t
            SOURCE_DISTANCE = parseFloat(controls.sourceDistance.value);
            controls.distValue.textContent = SOURCE_DISTANCE.toFixed(1);

            // C·∫≠p nh·∫≠t v·ªã tr√≠ ngu·ªìn sau khi thay ƒë·ªïi kho·∫£ng c√°ch
            setupSources(canvas.width, canvas.height);

            // C·∫≠p nh·∫≠t c√°c th√¥ng s·ªë kh√°c
            f = parseFloat(controls.frequency.value);
            deltaPhi_pi = parseFloat(controls.phaseDiff.value);
            A1 = parseFloat(controls.amp1.value);
            A2 = parseFloat(controls.amp2.value);

            controls.freqValue.textContent = f.toFixed(1);
            controls.phaseValue.textContent = deltaPhi_pi.toFixed(1);
            controls.amp1Value.textContent = A1.toFixed(1);
            controls.amp2Value.textContent = A2.toFixed(1);

            showMaxima = controls.toggleMaxima.checked;
            showMinima = controls.toggleMinima.checked;

            // N·∫øu t·∫°m d·ª´ng, c·∫ßn v·∫Ω l·∫°i ƒë·ªÉ hi·ªÉn th·ªã c√°c ƒë∆∞·ªùng tƒ©nh/ngu·ªìn v·ªõi tham s·ªë m·ªõi
            if (isPaused) {
                drawSimulation();
                if (showMaxima || showMinima) {
                    drawStaticLines();
                }
                drawSources();
                updateStats();
            }
        }

        // --- KH·ªûI T·∫†O ---

        function initialize() {
            // Th√™m listener cho n√∫t T·∫°m D·ª´ng
            controls.togglePause.addEventListener('click', togglePause);

            Object.values(controls).forEach(control => {
                // B·ªè qua n√∫t togglePause v√¨ n√≥ c√≥ listener ri√™ng
                if (control.id !== 'togglePause' && (control.type === 'range' || control.type === 'checkbox')) {
                    control.addEventListener('input', updateParameters);
                }
            });

            window.addEventListener('resize', handleResize);

            // ƒê·∫£m b·∫£o k√≠ch th∆∞·ªõc Canvas ƒë∆∞·ª£c thi·∫øt l·∫≠p v√† SOURCE_DISTANCE ƒë∆∞·ª£c c·∫≠p nh·∫≠t ban ƒë·∫ßu
            updateParameters();
            handleResize();

            if (!animationFrameId) {
                animationFrameId = requestAnimationFrame(animate);
            }
        }

        window.onload = initialize;

        // Custom function to handle theme updates in real-time
        window.addEventListener('theme-changed', (e) => {
            updateColorConstants();
            updateStaticColorConstants();
            if (isPaused) {
                drawSimulation();
                if (showMaxima || showMinima) drawStaticLines();
                drawSources();
            }
        });

    </script>
    <script src="js/theme.js"></script>
</body>

</html>