<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ph√¢n t√≠ch Dao ƒë·ªông T·∫Øt d·∫ßn N√¢ng cao</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for plotting the waveform -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        /* T√πy ch·ªânh cho v√πng ƒë·ªì th·ªã v√† thanh tr∆∞·ª£t */
        .chart-wrapper {
            position: relative;
        }
        .chart-container {
            position: relative;
            height: 50vh;
            width: 100%;
            min-height: 300px;
        }

        /* T√πy ch·ªânh style cho thanh tr∆∞·ª£t (Scrubbing Slider) */
        .scrub-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #cbd5e1; /* gray-300 */
            border-radius: 4px;
            cursor: pointer;
            position: absolute;
            z-index: 10;
            margin: 0;
            padding: 0;
            /* CƒÉn ch·ªânh v·ªõi tr·ª•c X c·ªßa Chart.js */
            left: 0;
            bottom: 10px; 
            transform: translateY(100%);
        }

        .scrub-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #ef4444; /* red-500 */
            cursor: grab;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }

        .scrub-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #ef4444; 
            cursor: grab;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }

    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8 font-sans">
    <a href="index.html" class="fixed top-4 left-4 z-50 p-3 bg-blue-600 text-white rounded-lg shadow-xl hover:bg-blue-700 transition duration-300 flex items-center space-x-2">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
    </svg>
    <span class="font-semibold hidden sm:inline">Quay v·ªÅ Trang Ch·ªß</span>
    </a>

    <div class="max-w-6xl mx-auto bg-white shadow-xl rounded-xl p-6 lg:p-10">
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-6 border-b-2 pb-2">
            M√¥ ph·ªèng & Ph√¢n T√≠ch S√≥ng Dao ƒê·ªông T·∫Øt D·∫ßn
        </h1>
        <p class="text-gray-600 mb-6 italic">
            ƒêi·ªÅu ch·ªânh c√°c ƒëi·ªÅu ki·ªán ban ƒë·∫ßu (Bi√™n ƒë·ªô, T·∫ßn s·ªë, Pha) v√† M·ª©c ƒë·ªô Suy gi·∫£m Bi√™n ƒë·ªô sau m·ªói chu k·ª≥.
        </p>

        <div class="grid grid-cols-1 lg:col-cols-3 gap-8">

            <!-- Khu v·ª±c Input Tham s·ªë -->
            <div class="lg:col-span-1 bg-gray-100 p-6 rounded-lg shadow-inner h-fit">
                
                <!-- 1. ƒêi·ªÅu ki·ªán Ban ƒë·∫ßu -->
                <h2 class="text-xl font-semibold text-gray-700 mb-4">1. ƒêi·ªÅu ki·ªán Ban ƒë·∫ßu</h2>
                
                <!-- Input Bi√™n ƒë·ªô ban ƒë·∫ßu (A) -->
                <div class="mb-4">
                    <label for="initialAmplitude" class="block text-sm font-medium text-gray-700">Bi√™n ƒë·ªô (A) [cm]</label>
                    <input type="number" id="initialAmplitude" value="10.0" step="1" min="0"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500">
                </div>

                <!-- Input T·∫ßn s·ªë dao ƒë·ªông (f) -->
                <div class="mb-4">
                    <label for="frequency" class="block text-sm font-medium text-gray-700">T·∫ßn s·ªë (f) [Hz]</label>
                    <input type="number" id="frequency" value="2.0" step="0.1" min="0.1"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500">
                </div>

                <!-- Input Pha ban ƒë·∫ßu (phi) -->
                <div class="mb-4">
                    <label for="initialPhase" class="block text-sm font-medium text-gray-700">Pha ban ƒë·∫ßu (&phi;) [rad]</label>
                    <input type="number" id="initialPhase" value="0.0" step="0.1"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500">
                </div>

                <!-- 2. H·ªá s·ªë C·∫£n / M√¥i tr∆∞·ªùng -->
                <h2 class="text-xl font-semibold text-gray-700 mb-4 mt-6 border-t pt-4 border-gray-300">2. M·ª©c ƒë·ªô T·∫Øt d·∫ßn</h2>

                 <!-- Selector M√¥i tr∆∞·ªùng -->
                <div class="mb-4">
                    <label for="environment" class="block text-sm font-medium text-gray-700">L·ª±a ch·ªçn M√¥i tr∆∞·ªùng</label>
                    <select id="environment" onchange="updateDampingPercentage()"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500 bg-white">
                        <option value="vacuum">Ch√¢n kh√¥ng (0.1% gi·∫£m)</option>
                        <option value="air" selected>Kh√¥ng kh√≠ (10% gi·∫£m)</option>
                        <option value="water">N∆∞·ªõc (50% gi·∫£m)</option>
                        <option value="custom">T√πy ch·ªânh (%)</option>
                    </select>
                </div>

                <!-- Input Ph·∫ßn trƒÉm bi√™n ƒë·ªô gi·∫£m sau 1 chu k·ª≥ -->
                <div class="mb-4">
                    <label for="reductionPercentage" class="block text-sm font-medium text-gray-700">Gi·∫£m Bi√™n ƒë·ªô sau 1 Chu k·ª≥ (%)</label>
                    <input type="number" id="reductionPercentage" value="10.0" step="1" min="0" max="99"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-blue-500 focus:ring-blue-500 bg-gray-200" disabled>
                    <p class="text-xs text-gray-500 mt-1">H·ªá s·ªë suy gi·∫£m ($\delta$) ƒë∆∞·ª£c t√≠nh t·ª± ƒë·ªông.</p>
                </div>

                <button id="plotButton" onclick="plotDampedOscillation()"
                        class="w-full bg-blue-600 text-white py-3 mt-6 rounded-lg shadow-lg hover:bg-blue-700 transition duration-200 font-bold">
                    V·∫Ω ƒê·ªì th·ªã S√≥ng
                </button>
            </div>

            <!-- Khu v·ª±c ƒê·ªì th·ªã v√† ƒêi·ªÅu khi·ªÉn Ch·∫•t ƒëi·ªÉm -->
            <div class="lg:col-span-2">
                <div class="bg-white p-6 rounded-lg shadow-md mb-2">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">ƒê·ªì th·ªã Li ƒë·ªô theo Th·ªùi gian</h2>
                    
                    <div class="chart-wrapper">
                        <!-- Canvas cho ƒë·ªì th·ªã -->
                        <div class="chart-container">
                            <canvas id="oscillationChart"></canvas>
                        </div>
                        
                        <!-- Thanh tr∆∞·ª£t ƒëi·ªÅu khi·ªÉn ch·∫•t ƒëi·ªÉm (Ngay d∆∞·ªõi tr·ª•c X) -->
                        <input type="range" id="timeSlider" min="0" max="10" value="0" step="0.01"
                            oninput="setTime(this.value)"
                            class="scrub-slider">
                    </div>
                    
                    <!-- Ki·ªÉm so√°t Ph√°t/T·∫°m d·ª´ng v√† Hi·ªÉn th·ªã Th·ªùi gian -->
                    <div class="mt-16 pt-4 border-t border-gray-300">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-gray-700">Ki·ªÉm so√°t M√¥ ph·ªèng</h3>
                            <div id="currentTimeDisplay" class="text-md font-mono text-gray-700">t = 0.00 s</div>
                        </div>
                        <div class="flex space-x-2">
                            <!-- N√∫t Ph√°t / T·∫°m d·ª´ng -->
                            <button id="toggleAnimation" onclick="toggleAnimation()"
                                    class="flex-1 py-2 rounded-lg text-white font-bold transition duration-200 bg-green-600 hover:bg-green-700 shadow-md">
                                ‚ñ∂Ô∏è Ph√°t
                            </button>
                            <!-- N√∫t ƒê·∫∑t l·∫°i -->
                            <button id="resetButton" onclick="resetAnimation()"
                                    class="flex-1 py-2 rounded-lg text-white font-bold transition duration-200 bg-gray-500 hover:bg-gray-600 shadow-md">
                                üîÑ ƒê·∫∑t l·∫°i
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        let oscillationChart;
        let animationFrameId = null;
        let chartStartTime = null;
        let isRunning = false; 
        let maxSimTime = 10.0; 
        let particleTime = 0; 
        
        const PI = Math.PI;

        // ƒê·ªãnh nghƒ©a c√°c Ph·∫ßn trƒÉm Bi√™n ƒë·ªô Gi·∫£m sau 1 Chu k·ª≥ (%)
        const REDUCTION_PERCENTAGES = {
            vacuum: 0.1, // R·∫•t nh·ªè
            air: 10.0,   // Suy gi·∫£m y·∫øu
            water: 50.0, // Suy gi·∫£m m·∫°nh
            custom: 10.0 
        };
        
        // H√†m c·∫≠p nh·∫≠t ph·∫ßn trƒÉm gi·∫£m bi√™n ƒë·ªô v√† b·∫≠t/t·∫Øt √¥ nh·∫≠p li·ªáu
        function updateDampingPercentage() {
            const environment = document.getElementById('environment').value;
            const reductionInput = document.getElementById('reductionPercentage');

            if (environment === 'custom') {
                // Cho ph√©p ng∆∞·ªùi d√πng nh·∫≠p % th·ªß c√¥ng
                reductionInput.disabled = false;
                reductionInput.classList.remove('bg-gray-200');
            } else {
                // T·ª± ƒë·ªông g√°n % d·ª±a tr√™n m√¥i tr∆∞·ªùng
                reductionInput.value = REDUCTION_PERCENTAGES[environment].toFixed(1);
                reductionInput.disabled = true;
                reductionInput.classList.add('bg-gray-200');
            }

            // V·∫Ω l·∫°i ƒë·ªì th·ªã v·ªõi tham s·ªë m·ªõi
            plotDampedOscillation();
        }

        /**
         * H√†m t√≠nh H·ªá s·ªë Suy gi·∫£m (delta) d·ª±a tr√™n t·∫ßn s·ªë v√† % gi·∫£m bi√™n ƒë·ªô sau 1 chu k·ª≥.
         * delta = -f * ln(1 - P/100)
         * @param {number} f T·∫ßn s·ªë (Hz)
         * @param {number} P Ph·∫ßn trƒÉm gi·∫£m bi√™n ƒë·ªô (0-99)
         * @returns {number} H·ªá s·ªë suy gi·∫£m (1/s)
         */
        function calculateDelta(f, P) {
            if (P <= 0 || f <= 0) return 0;
            const ratio = 1 - (P / 100);
            if (ratio <= 0) {
                // Tr∆∞·ªùng h·ª£p c·∫£n qu√° m·∫°nh (P >= 100%), coi nh∆∞ t·∫Øt d·∫ßn t·ª©c th·ªùi
                return 100 * f; 
            }
            // Logarit t·ª± nhi√™n c·ªßa t·ªâ l·ªá c√≤n l·∫°i
            return -f * Math.log(ratio);
        }

        /**
         * H√†m t√≠nh li ƒë·ªô x(t) cho h·ªá th·ªëng dao ƒë·ªông t·∫Øt d·∫ßn.
         * C√¥ng th·ª©c t·ªïng qu√°t: x(t) = A * exp(-delta * t) * cos(omega * t + phi)
         */
        function calculatePosition(t, A0_m, f, phi_rad, delta) {
            const omega = 2 * PI * f;
            return A0_m * Math.exp(-delta * t) * Math.cos(omega * t + phi_rad);
        }
        
        // L·∫•y c√°c tham s·ªë ƒë·ªông t·ª´ UI
        function getDynamicParams() {
             const A0_cm = parseFloat(document.getElementById('initialAmplitude').value); // cm
             const f = parseFloat(document.getElementById('frequency').value); // Hz
             const phi_rad = parseFloat(document.getElementById('initialPhase').value); // rad
             const P = parseFloat(document.getElementById('reductionPercentage').value); // %
             
             // Chuy·ªÉn Bi√™n ƒë·ªô sang ƒë∆°n v·ªã chu·∫©n (m√©t)
             const A0_m = A0_cm / 100.0; 
             
             // T√≠nh to√°n delta
             const delta = calculateDelta(f, P);

             return { A0_m, f, phi_rad, P, delta, A0_cm };
        }

        // === CONTROL FUNCTIONS ===

        /**
         * C·∫≠p nh·∫≠t v·ªã tr√≠ h·∫°t, hi·ªÉn th·ªã th·ªùi gian v√† ƒë·ªì th·ªã.
         * H√†m n√†y ƒë∆∞·ª£c g·ªçi trong v√≤ng l·∫∑p ho·∫°t ·∫£nh (animateParticle) v√† khi ng∆∞·ªùi d√πng k√©o thanh tr∆∞·ª£t (setTime).
         */
        function updateParticleState(timeValue) {
            particleTime = parseFloat(timeValue);
            
            // C·∫≠p nh·∫≠t hi·ªÉn th·ªã th·ªùi gian
            document.getElementById('currentTimeDisplay').textContent = `t = ${particleTime.toFixed(2)} s`;
            
            // T√≠nh to√°n v·ªã tr√≠ h·∫°t t·∫°i th·ªùi ƒëi·ªÉm m·ªõi
            const { A0_m, f, phi_rad, delta } = getDynamicParams();
            const x_t = calculatePosition(particleTime, A0_m, f, phi_rad, delta);

            // C·∫≠p nh·∫≠t v·ªã tr√≠ h·∫°t tr√™n ƒë·ªì th·ªã v√† ƒë∆∞·ªùng chi·∫øu
            if (oscillationChart && oscillationChart.data.datasets.length >= 2) {
                // Dataset 0 l√† h·∫°t m√¥ ph·ªèng
                oscillationChart.data.datasets[0].data = [{ x: particleTime, y: x_t }]; 
                
                // Dataset 1 l√† ƒë∆∞·ªùng k·∫ª chi·∫øu vu√¥ng g√≥c v·ªõi tr·ª•c th·ªùi gian (y=0)
                oscillationChart.data.datasets[1].data = [
                    { x: particleTime, y: x_t }, // T·ª´ v·ªã tr√≠ h·∫°t
                    { x: particleTime, y: 0 }    // ƒê·∫øn tr·ª•c X (y=0)
                ];

                // C·∫≠p nh·∫≠t m√† kh√¥ng ch·∫°y l·∫°i animation
                oscillationChart.update('none'); 
            }
        }
        
        /**
         * X·ª≠ l√Ω khi ng∆∞·ªùi d√πng k√©o thanh tr∆∞·ª£t (Scrubbing).
         * N√≥ ph·∫£i d·ª´ng m·ªçi ho·∫°t ·∫£nh ƒëang ch·∫°y ƒë·ªÉ cho ph√©p xem th·ªß c√¥ng.
         */
        function setTime(timeValue) {
            // 1. T·∫°m d·ª´ng animation n·∫øu ƒëang ch·∫°y (v√¨ ng∆∞·ªùi d√πng ƒëang k√©o tr∆∞·ª£t)
            if (isRunning) {
                isRunning = false;
                document.getElementById('toggleAnimation').textContent = '‚ñ∂Ô∏è Ph√°t';
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }
            }
            // 2. C·∫≠p nh·∫≠t tr·∫°ng th√°i
            updateParticleState(timeValue);
        }

        function toggleAnimation() {
            isRunning = !isRunning;
            const button = document.getElementById('toggleAnimation');
            if (isRunning) {
                button.textContent = '‚è∏ T·∫°m d·ª´ng';
                // B·∫Øt ƒë·∫ßu l·∫°i animation loop n·∫øu n√≥ ƒë√£ d·ª´ng
                if (!animationFrameId) {
                    chartStartTime = null; 
                    animationFrameId = requestAnimationFrame(animateParticle);
                }
            } else {
                button.textContent = '‚ñ∂Ô∏è Ph√°t';
                // H·ªßy animation frame khi t·∫°m d·ª´ng
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }
            }
        }

        function resetAnimation() {
            // 1. D·ª´ng m·ªçi ho·∫°t ·∫£nh
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            isRunning = false;
            chartStartTime = null;
            particleTime = 0;
            
            // 2. C·∫≠p nh·∫≠t n√∫t
            document.getElementById('toggleAnimation').textContent = '‚ñ∂Ô∏è Ph√°t';
            
            // 3. Ch·∫°y l·∫°i h√†m plot ƒë·ªÉ ƒë·∫∑t l·∫°i maxSimTime, slider max v√† v·∫Ω l·∫°i ƒë∆∞·ªùng cong
            plotDampedOscillation(); 
            
            // 4. ƒê·∫£m b·∫£o ch·∫•t ƒëi·ªÉm ƒë∆∞·ª£c ƒë·∫∑t v·ªÅ 0 v√† c·∫≠p nh·∫≠t UI/Chart
            document.getElementById('timeSlider').value = 0; // ƒê·∫∑t l·∫°i slider
            updateParticleState(0); // C·∫≠p nh·∫≠t tr·∫°ng th√°i h·∫°t t·∫°i t=0
        }

        // H√†m c·∫≠p nh·∫≠t v·ªã tr√≠ h·∫°t m√¥ ph·ªèng theo th·ªùi gian
        function animateParticle(timestamp) {
            // Ki·ªÉm tra tr·∫°ng th√°i ƒëang ch·∫°y
            if (!isRunning) {
                // ƒê√£ d·ª´ng, kh√¥ng ti·∫øp t·ª•c loop
                return;
            }
            
            // 1. Kh·ªüi t·∫°o/T√°i kh·ªüi t·∫°o th·ªùi gian b·∫Øt ƒë·∫ßu
            if (chartStartTime === null) {
                // T√≠nh to√°n th·ªùi gian b·∫Øt ƒë·∫ßu d·ª±a tr√™n th·ªùi gian h·∫°t hi·ªán t·∫°i (n·∫øu ƒëang t·∫°m d·ª´ng)
                chartStartTime = timestamp - particleTime * 1000; 
            }

            // 2. T√≠nh th·ªùi gian ƒë√£ tr√¥i qua
            const elapsedSeconds = (timestamp - chartStartTime) / 1000;
            const currentTime = elapsedSeconds;

            // 3. X·ª≠ l√Ω k·∫øt th√∫c m√¥ ph·ªèng
            if (currentTime >= maxSimTime) {
                // D·ª´ng m√¥ ph·ªèng
                particleTime = maxSimTime;
                isRunning = false;
                document.getElementById('toggleAnimation').textContent = '‚ñ∂Ô∏è Ph√°t';
                chartStartTime = null;
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }
            } else {
                particleTime = currentTime;
            }

            // 4. C·∫≠p nh·∫≠t slider v√† v·ªã tr√≠ h·∫°t 
            document.getElementById('timeSlider').value = particleTime;
            updateParticleState(particleTime); 

            // 5. Ti·∫øp t·ª•c loop 
            if (isRunning && particleTime < maxSimTime) {
                animationFrameId = requestAnimationFrame(animateParticle);
            }
        }

        // H√†m t√≠nh to√°n v√† v·∫Ω ƒë·ªì th·ªã
        function plotDampedOscillation() {
            // Lu√¥n ƒë·∫£m b·∫£o animation d·ª´ng khi v·∫Ω l·∫°i ƒë·ªì th·ªã
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            isRunning = false;
            document.getElementById('toggleAnimation').textContent = '‚ñ∂Ô∏è Ph√°t';
            chartStartTime = null;
            particleTime = 0;


            const { A0_m, f, phi_rad, P, delta, A0_cm } = getDynamicParams();

            // 1. Ki·ªÉm tra l·ªói ƒë·∫ßu v√†o
            if (isNaN(A0_cm) || isNaN(f) || isNaN(phi_rad) || isNaN(P) || A0_cm < 0 || f <= 0 || P < 0 || P > 99.99) {
                if (oscillationChart) { oscillationChart.destroy(); }
                console.error("L·ªói tham s·ªë ƒë·∫ßu v√†o. Vui l√≤ng ki·ªÉm tra Bi√™n ƒë·ªô (A >= 0), T·∫ßn s·ªë (f > 0), v√† % Gi·∫£m (0 <= P < 100).");
                return;
            } 

            // 2. T√≠nh to√°n th·ªùi gian m√¥ ph·ªèng ƒë·ªông
            let calculatedMaxSimTime;
            if (delta > 0) {
                // Th·ªùi gian ƒë·ªÉ bi√™n ƒë·ªô gi·∫£m c√≤n 1% so v·ªõi ban ƒë·∫ßu (ln(100)/delta)
                calculatedMaxSimTime = Math.log(100) / delta; 
            } else {
                // Kh√¥ng suy gi·∫£m (SHM) ho·∫∑c delta qu√° nh·ªè: 10 chu k·ª≥
                calculatedMaxSimTime = 10 * (1/f); 
            }
            
            // ƒê·∫£m b·∫£o th·ªùi gian m√¥ ph·ªèng t·ªëi thi·ªÉu 5s v√† t·ªëi ƒëa 30s
            maxSimTime = Math.min(Math.max(calculatedMaxSimTime, 5.0), 30.0); 

            const timePoints = 500; 
            const timeStep = maxSimTime / timePoints;

            // C·∫≠p nh·∫≠t thanh tr∆∞·ª£t th·ªùi gian v·ªõi gi√° tr·ªã max m·ªõi v√† reset v·ªÅ 0
            const timeSlider = document.getElementById('timeSlider');
            timeSlider.max = maxSimTime.toFixed(2);
            timeSlider.value = 0; // ƒê·∫∑t l·∫°i gi√° tr·ªã slider

            let dataPoints = [];
            let envelopeUpper = [];
            let envelopeLower = [];
            let max_x_t_abs = 0;
            
            // 3. T√≠nh to√°n d·ªØ li·ªáu ƒë·ªì th·ªã v√† ƒë∆∞·ªùng bao suy gi·∫£m
            for (let i = 0; i <= timePoints; i++) {
                const t = i * timeStep;
                const x_t = calculatePosition(t, A0_m, f, phi_rad, delta);
                
                dataPoints.push({ x: t, y: x_t });
                
                max_x_t_abs = Math.max(max_x_t_abs, Math.abs(x_t));

                const envelope = A0_m * Math.exp(-delta * t);
                envelopeUpper.push({ x: t, y: envelope });
                envelopeLower.push({ x: t, y: -envelope });
            }


            // 4. C·∫≠p nh·∫≠t ƒê·ªì th·ªã Chart.js
            const ctx = document.getElementById('oscillationChart').getContext('2d');

            // H·∫°t m√¥ ph·ªèng
            const particleDataset = {
                label: 'Ch·∫•t ƒëi·ªÉm m√¥ ph·ªèng',
                data: [{ x: 0, y: calculatePosition(0, A0_m, f, phi_rad, delta) }], 
                backgroundColor: 'rgb(239, 68, 68)', // ƒê·ªè
                borderColor: 'rgb(239, 68, 68)', 
                borderWidth: 1,
                pointRadius: 8, 
                type: 'scatter', 
                showLine: false
            };

            // ƒê∆∞·ªùng k·∫ª chi·∫øu xu·ªëng tr·ª•c th·ªùi gian (ƒê∆∞·ªùng m·ªù vu√¥ng g√≥c)
            const initialX = calculatePosition(0, A0_m, f, phi_rad, delta);
            const projectionDataset = {
                label: 'ƒê∆∞·ªùng chi·∫øu th·ªùi gian',
                data: [{ x: 0, y: initialX }, { x: 0, y: 0 }], 
                // TƒÉng ƒë·ªô ƒë·∫≠m ƒë∆∞·ªùng chi·∫øu
                borderColor: 'rgba(239, 68, 68, 0.8)', 
                borderWidth: 2, 
                borderDash: [5, 5], 
                pointRadius: 0,
                fill: false,
                tension: 0,
                type: 'line',
                hidden: false
            };


            const datasets = [
                particleDataset,
                projectionDataset, // Dataset 1: ƒê∆∞·ªùng k·∫ª chi·∫øu
                {
                    label: 'Li ƒë·ªô x(t) [m]',
                    data: dataPoints,
                    borderColor: 'rgb(59, 130, 246)', // Xanh d∆∞∆°ng
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 4, // TƒÉng ƒë·ªô ƒë·∫≠m
                    pointRadius: 0,
                    tension: 0.2,
                    fill: false,
                    type: 'line'
                },
                 {
                    label: 'ƒê∆∞·ªùng bao suy gi·∫£m',
                    data: envelopeUpper,
                    borderColor: 'rgba(251, 191, 36, 0.9)', // V√†ng (tƒÉng ƒë·ªô m·ªù)
                    borderWidth: 2, // TƒÉng ƒë·ªô ƒë·∫≠m 
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false,
                    tension: 0.2,
                    type: 'line'
                },
                {
                    label: 'ƒê∆∞·ªùng bao suy gi·∫£m (d∆∞·ªõi)',
                    data: envelopeLower,
                    borderColor: 'rgba(251, 191, 36, 0.9)', 
                    borderWidth: 2, 
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false,
                    tension: 0.2,
                    hidden: true, 
                    type: 'line'
                }
            ];

            // ƒê·∫£m b·∫£o tr·ª•c Y c√≥ ƒë·ªß kh√¥ng gian cho bi√™n ƒë·ªô
            const y_max = Math.max(0.01, 1.1 * max_x_t_abs);

            // C·∫•u h√¨nh Chart.js
            const chartConfig = {
                data: {
                    datasets: datasets 
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false, 
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Th·ªùi gian t (s)',
                                color: '#4b5563'
                            },
                            min: 0,
                            max: maxSimTime, 
                            type: 'linear',
                            grid: {
                                // ƒê·ªô ƒë·∫≠m l∆∞·ªõi tr·ª•c X (ƒê√É TƒÇNG)
                                color: 'rgba(0, 0, 0, 0.3)',
                                lineWidth: 1 // ƒê·ªô d√†y ƒë∆∞·ªùng l∆∞·ªõi
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Li ƒë·ªô x (m)',
                                color: '#4b5563'
                            },
                            min: -y_max,
                            max: y_max,
                            grid: {
                                // ƒê·ªô ƒë·∫≠m l∆∞·ªõi tr·ª•c Y (ƒê√É TƒÇNG)
                                color: 'rgba(0, 0, 0, 0.3)',
                                lineWidth: 1 // ƒê·ªô d√†y ƒë∆∞·ªùng l∆∞·ªõi
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                filter: function(item, chart) {
                                    // ·∫®n nh√£n c·ªßa ƒë∆∞·ªùng bao suy gi·∫£m d∆∞·ªõi v√† ƒë∆∞·ªùng chi·∫øu th·ªùi gian
                                    return item.text !== 'ƒê∆∞·ªùng bao suy gi·∫£m (d∆∞·ªõi)' && item.text !== 'ƒê∆∞·ªùng chi·∫øu th·ªùi gian';
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: `Dao ƒë·ªông T·∫Øt d·∫ßn (f=${f} Hz, Gi·∫£m ${P}% / Chu k·ª≥)`,
                            font: {
                                size: 16
                            }
                        }
                    }
                }
            };

            // H·ªßy bi·ªÉu ƒë·ªì c≈© n·∫øu n√≥ t·ªìn t·∫°i
            if (oscillationChart) {
                oscillationChart.destroy();
            }

            // T·∫°o bi·ªÉu ƒë·ªì m·ªõi
            oscillationChart = new Chart(ctx, chartConfig);
            
            // Kh·ªüi t·∫°o v·ªã tr√≠ h·∫°t t·∫°i t=0
            updateParticleState(0);

        }

        // T·ª± ƒë·ªông v·∫Ω ƒë·ªì th·ªã khi t·∫£i trang l·∫ßn ƒë·∫ßu
        window.onload = function() {
            // Thi·∫øt l·∫≠p % gi·∫£m ban ƒë·∫ßu theo m√¥i tr∆∞·ªùng m·∫∑c ƒë·ªãnh (Kh√¥ng kh√≠)
            updateDampingPercentage(); 

            // G√°n s·ª± ki·ªán cho c√°c input ƒë·ªông ƒë·ªÉ c·∫≠p nh·∫≠t ƒë·ªì th·ªã ngay l·∫≠p t·ª©c
            document.getElementById('initialAmplitude').addEventListener('change', plotDampedOscillation);
            document.getElementById('frequency').addEventListener('change', plotDampedOscillation);
            document.getElementById('initialPhase').addEventListener('change', plotDampedOscillation);
            document.getElementById('reductionPercentage').addEventListener('change', plotDampedOscillation);
        }
    </script>
</body>
</html>